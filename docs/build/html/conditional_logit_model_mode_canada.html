
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Example of the Conditional Logit Model on ModeCanada Dataset &#8212; torch-choice  documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Random Utility Model (RUM) Part II: Nested Logit Model" href="nested_logit_model_house_cooling.html" />
    <link rel="prev" title="Data Management Tutorial" href="data_management.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section class="tex2jax_ignore mathjax_ignore" id="example-of-the-conditional-logit-model-on-modecanada-dataset">
<h1>Example of the Conditional Logit Model on ModeCanada Dataset<a class="headerlink" href="#example-of-the-conditional-logit-model-on-modecanada-dataset" title="Permalink to this headline">¶</a></h1>
<p>This tutorial is modified from the <a class="reference external" href="https://cran.r-project.org/web/packages/mlogit/vignettes/c3.rum.html">Random utility model and the multinomial logit model</a> in th documentation of <code class="docutils literal notranslate"><span class="pre">mlogit</span></code> package in R. Please note that the dataset involved in this example is fairly small (2,779 choice records), so we don’t expect the performance to be faster than the R implementation. We provide this tutorial mainly to check the correctness of our prediction. The fully potential of PyTorch is better exploited on much larger dataset.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">argparse</span>

<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>

<span class="kn">from</span> <span class="nn">torch_choice.data</span> <span class="kn">import</span> <span class="n">ChoiceDataset</span><span class="p">,</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">torch_choice.model</span> <span class="kn">import</span> <span class="n">ConditionalLogitModel</span>

<span class="kn">from</span> <span class="nn">torch_choice.utils.run_helper</span> <span class="kn">import</span> <span class="n">run</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;CUDA device used: </span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">get_device_name</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>CUDA device used: NVIDIA GeForce RTX 3090
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">args</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">(</span><span class="n">data_path</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">,</span>
                          <span class="n">batch_size</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># full-batch.</span>
                          <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">num_epochs</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span>
                          <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
</pre></div>
</div>
<section id="load-dataset">
<h2>Load Dataset<a class="headerlink" href="#load-dataset" title="Permalink to this headline">¶</a></h2>
<p>We have included the <code class="docutils literal notranslate"><span class="pre">ModeCanada</span></code> dataset in our package. The <code class="docutils literal notranslate"><span class="pre">ModeCanada</span></code> dataset contains individuals’ choice on traveling methods. The raw dataset is in a long-format, in which the <code class="docutils literal notranslate"><span class="pre">case</span></code> variable identifies each choice. For example, the first four row (with <code class="docutils literal notranslate"><span class="pre">case</span> <span class="pre">==</span> <span class="pre">109</span></code>) corresponds to the first choice, the <code class="docutils literal notranslate"><span class="pre">alt</span></code> column lists all alternatives/items available. The <code class="docutils literal notranslate"><span class="pre">choice</span></code> column identifies which alternative/item is chosen. In this example with <code class="docutils literal notranslate"><span class="pre">choice</span> <span class="pre">==</span> <span class="pre">1</span></code> on <code class="docutils literal notranslate"><span class="pre">air</span></code> alternative, the decision maker chose to travel by <code class="docutils literal notranslate"><span class="pre">air</span></code> among four available alternatives/items/traveling modes.</p>
<p>Now we convert the raw dataset into the format compatible with our model.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;./public_datasets/ModeCanada.csv&#39;</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;noalt == 4&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;case&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</pre></div>
</div>
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Unnamed: 0</th>
      <th>case</th>
      <th>alt</th>
      <th>choice</th>
      <th>dist</th>
      <th>cost</th>
      <th>ivt</th>
      <th>ovt</th>
      <th>freq</th>
      <th>income</th>
      <th>urban</th>
      <th>noalt</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>304</td>
      <td>109</td>
      <td>train</td>
      <td>0</td>
      <td>377</td>
      <td>58.25</td>
      <td>215</td>
      <td>74</td>
      <td>4</td>
      <td>45</td>
      <td>0</td>
      <td>4</td>
    </tr>
    <tr>
      <th>1</th>
      <td>305</td>
      <td>109</td>
      <td>air</td>
      <td>1</td>
      <td>377</td>
      <td>142.80</td>
      <td>56</td>
      <td>85</td>
      <td>9</td>
      <td>45</td>
      <td>0</td>
      <td>4</td>
    </tr>
    <tr>
      <th>2</th>
      <td>306</td>
      <td>109</td>
      <td>bus</td>
      <td>0</td>
      <td>377</td>
      <td>27.52</td>
      <td>301</td>
      <td>63</td>
      <td>8</td>
      <td>45</td>
      <td>0</td>
      <td>4</td>
    </tr>
    <tr>
      <th>3</th>
      <td>307</td>
      <td>109</td>
      <td>car</td>
      <td>0</td>
      <td>377</td>
      <td>71.63</td>
      <td>262</td>
      <td>0</td>
      <td>0</td>
      <td>45</td>
      <td>0</td>
      <td>4</td>
    </tr>
    <tr>
      <th>4</th>
      <td>308</td>
      <td>110</td>
      <td>train</td>
      <td>0</td>
      <td>377</td>
      <td>58.25</td>
      <td>215</td>
      <td>74</td>
      <td>4</td>
      <td>70</td>
      <td>0</td>
      <td>4</td>
    </tr>
  </tbody>
</table>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>(11116, 12)
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">item_index</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;choice&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;case&#39;</span><span class="p">)[</span><span class="s1">&#39;alt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">item_index</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>0       air
1       air
2       air
3       air
4       air
       ... 
2774    car
2775    car
2776    car
2777    car
2778    car
Name: alt, Length: 2779, dtype: object
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">item_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;air&#39;</span><span class="p">,</span> <span class="s1">&#39;bus&#39;</span><span class="p">,</span> <span class="s1">&#39;car&#39;</span><span class="p">,</span> <span class="s1">&#39;train&#39;</span><span class="p">]</span>
<span class="n">num_items</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">encoder</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">item_names</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_items</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">encoder</span><span class="si">=:}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">item_index</span> <span class="o">=</span> <span class="n">item_index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">encoder</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
<span class="n">item_index</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">item_index</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">item_index</span><span class="si">=:}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>encoder={&#39;air&#39;: 0, &#39;bus&#39;: 1, &#39;car&#39;: 2, &#39;train&#39;: 3}
item_index=tensor([0, 0, 0,  ..., 2, 2, 2])
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">price_cost_freq_ovt</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">pivot3d</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">dim0</span><span class="o">=</span><span class="s1">&#39;case&#39;</span><span class="p">,</span> <span class="n">dim1</span><span class="o">=</span><span class="s1">&#39;alt&#39;</span><span class="p">,</span>
                                    <span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cost&#39;</span><span class="p">,</span> <span class="s1">&#39;freq&#39;</span><span class="p">,</span> <span class="s1">&#39;ovt&#39;</span><span class="p">])</span>
<span class="c1"># session_income = torch.Tensor(df[[&#39;income&#39;]].values).view(-1, 1)</span>
<span class="n">session_income</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;case&#39;</span><span class="p">)[</span><span class="s1">&#39;income&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="n">session_income</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">session_income</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">price_ivt</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">pivot3d</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">dim0</span><span class="o">=</span><span class="s1">&#39;case&#39;</span><span class="p">,</span> <span class="n">dim1</span><span class="o">=</span><span class="s1">&#39;alt&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;ivt&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">ChoiceDataset</span></code> constructed contains 2779 choice records. Since the original dataset did not reveal the identity of each decision maker, we consider all 2779 choices were made by a single user but in 2779 different sessions to handle variations.</p>
<p>In this case, the <code class="docutils literal notranslate"><span class="pre">cost</span></code>, <code class="docutils literal notranslate"><span class="pre">freq</span></code> and <code class="docutils literal notranslate"><span class="pre">ovt</span></code> are observables depending on both sessions and items, we created a <code class="docutils literal notranslate"><span class="pre">price_cost_freq_ovt</span></code> tensor with shape <code class="docutils literal notranslate"><span class="pre">(num_sessions,</span> <span class="pre">num_items,</span> <span class="pre">3)</span> <span class="pre">=</span> <span class="pre">(2779,</span> <span class="pre">4,</span> <span class="pre">3)</span></code> to contain these variables.
In contrast, the <code class="docutils literal notranslate"><span class="pre">income</span></code> information depends only on session but not on items, hence we create the <code class="docutils literal notranslate"><span class="pre">session_income</span></code> tensor to store it.</p>
<p>Because we wish to fit item-specific coefficients for the <code class="docutils literal notranslate"><span class="pre">ivt</span></code> variable, which varies by both sessions and items as well, we create another <code class="docutils literal notranslate"><span class="pre">price_ivt</span></code> tensor in addition to the <code class="docutils literal notranslate"><span class="pre">price_cost_freq_ovt</span></code> tensor.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dataset</span><span class="o">=</span> <span class="n">ChoiceDataset</span><span class="p">(</span><span class="n">item_index</span><span class="o">=</span><span class="n">item_index</span><span class="p">,</span>
                       <span class="n">price_cost_freq_ovt</span><span class="o">=</span><span class="n">price_cost_freq_ovt</span><span class="p">,</span>
                       <span class="n">session_income</span><span class="o">=</span><span class="n">session_income</span><span class="p">,</span>
                       <span class="n">price_ivt</span><span class="o">=</span><span class="n">price_ivt</span>
                       <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<span class="c1"># data_loader = utils.create_data_loader(dataset, batch_size=-1, shuffle=True)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dataset</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ChoiceDataset(label=[], item_index=[2779], user_index=[], session_index=[2779], item_availability=[], price_cost_freq_ovt=[2779, 4, 3], session_income=[2779, 1], price_ivt=[2779, 4, 1], device=cuda:0)
</pre></div>
</div>
</section>
<section id="create-the-model">
<h2>Create the Model<a class="headerlink" href="#create-the-model" title="Permalink to this headline">¶</a></h2>
<p>We aim to estimate the following model formulation:
$<span class="math notranslate nohighlight">\(
U_{uit} = \beta^0_i + \beta^{1\top} X^{price: (cost, freq, ovt)}_{it} + \beta^2_i X^{session:income}_t + \beta^3_i X_{it}^{price:ivt} + \epsilon_{uit}
\)</span>$</p>
<p>We now initialize the <code class="docutils literal notranslate"><span class="pre">ConditionalLogitModel</span></code> to predict choices from the dataset. Please see the documentation <span class="xref myst">here</span> for a complete description of the <code class="docutils literal notranslate"><span class="pre">ConditionalLogitModel</span></code> class.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">ConditionalLogitModel</span></code> constructor requires four components:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">coef_variation_dict</span></code> is a dictionary with variable names (defined above while constructing the dataset) as keys and values from <code class="docutils literal notranslate"><span class="pre">{constant,</span> <span class="pre">user,</span> <span class="pre">item,</span> <span class="pre">item-full}</span></code>. For instance, since we wish to have constant coefficients for <code class="docutils literal notranslate"><span class="pre">cost</span></code>, <code class="docutils literal notranslate"><span class="pre">freq</span></code> and <code class="docutils literal notranslate"><span class="pre">ovt</span></code> observables, and these three observables are stored in the <code class="docutils literal notranslate"><span class="pre">price_cost_freq_ovt</span></code> tensor of the choice dataset, we set <code class="docutils literal notranslate"><span class="pre">coef_variation_dict['price_cost_freq_ovt']</span> <span class="pre">=</span> <span class="pre">'constant'</span></code>.
The models allows for the option of enforcing coefficient for one item to be zero, the variation of <span class="math notranslate nohighlight">\(\beta^3\)</span> is specified as <code class="docutils literal notranslate"><span class="pre">item-full</span></code> which indicates 4 values of <span class="math notranslate nohighlight">\(\beta^3\)</span> is learned (one for each item). In contrast, <span class="math notranslate nohighlight">\(\beta^0, \beta^2\)</span> are specified to have variation <code class="docutils literal notranslate"><span class="pre">item</span></code> instead of <code class="docutils literal notranslate"><span class="pre">item-full</span></code>. In this case, the <span class="math notranslate nohighlight">\(\beta\)</span> correspond to the first item (i.e., the baseline item, which is encoded as 0 in the label tensor) is force to be zero.
The researcher needs to declare <code class="docutils literal notranslate"><span class="pre">intercept</span></code> (as shown below) manually for the model to fit an intercept as well, otherwise the model assumes zero intercept term.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">num_param_dict</span></code> is a dictionary with keys exactly the same as the <code class="docutils literal notranslate"><span class="pre">coef_variation_dict</span></code>. Each of dictionary values tells the dimension of the corresponding observables (hence the dimension of the coefficient). For example, the <code class="docutils literal notranslate"><span class="pre">price_cost_freq_ovt</span></code> consists of three observables and we set the corresponding to three.
Even the model can infer <code class="docutils literal notranslate"><span class="pre">num_param_dict['intercept']</span> <span class="pre">=</span> <span class="pre">1</span></code>, but we recommend the research to include it for completeness.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">num_items</span></code> informs the model how many alternatives users are choosing from.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">num_users</span></code> is an optional integer informing the model how many users there are in the dataset. However, in this example we implicitly assume there is only one user making all the decisions and we do not have any <code class="docutils literal notranslate"><span class="pre">user_obs</span></code> involved, hence <code class="docutils literal notranslate"><span class="pre">num_users</span></code> argument is not supplied.</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">ConditionalLogitModel</span><span class="p">(</span><span class="n">coef_variation_dict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;price_cost_freq_ovt&#39;</span><span class="p">:</span> <span class="s1">&#39;constant&#39;</span><span class="p">,</span>
                                                   <span class="s1">&#39;session_income&#39;</span><span class="p">:</span> <span class="s1">&#39;item&#39;</span><span class="p">,</span>
                                                   <span class="s1">&#39;price_ivt&#39;</span><span class="p">:</span> <span class="s1">&#39;item-full&#39;</span><span class="p">,</span>
                                                   <span class="s1">&#39;intercept&#39;</span><span class="p">:</span> <span class="s1">&#39;item&#39;</span><span class="p">},</span>
                              <span class="n">num_param_dict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;price_cost_freq_ovt&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                                              <span class="s1">&#39;session_income&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                                              <span class="s1">&#39;price_ivt&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                                              <span class="s1">&#39;intercept&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
                              <span class="n">num_items</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="train-the-model">
<h2>Train the Model<a class="headerlink" href="#train-the-model" title="Permalink to this headline">¶</a></h2>
<p>The model takes in a <code class="docutils literal notranslate"><span class="pre">ChoiceDataset</span></code> object in and return predicted potentials for each alternatives. The shape of output would be <code class="docutils literal notranslate"><span class="pre">len(dataset)</span> <span class="pre">X</span> <span class="pre">num_items</span></code>.
We provide an easy-to-use model runner for both <code class="docutils literal notranslate"><span class="pre">ConditionalLogitModel</span></code> and <code class="docutils literal notranslate"><span class="pre">NestedLogitModel</span></code> instances.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
<span class="n">run</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">num_epochs</span><span class="o">=</span><span class="mi">50000</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time taken:&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>==================== received model ====================
ConditionalLogitModel(
  (coef_dict): ModuleDict(
    (price_cost_freq_ovt): Coefficient(variation=constant, num_items=4, num_users=None, num_params=3, 3 trainable parameters in total).
    (session_income): Coefficient(variation=item, num_items=4, num_users=None, num_params=1, 3 trainable parameters in total).
    (price_ivt): Coefficient(variation=item-full, num_items=4, num_users=None, num_params=1, 4 trainable parameters in total).
    (intercept): Coefficient(variation=item, num_items=4, num_users=None, num_params=1, 3 trainable parameters in total).
  )
)
Conditional logistic discrete choice model, expects input features:

X[price_cost_freq_ovt] with 3 parameters, with constant level variation.
X[session_income] with 1 parameters, with item level variation.
X[price_ivt] with 1 parameters, with item-full level variation.
X[intercept] with 1 parameters, with item level variation.
==================== received dataset ====================
ChoiceDataset(label=[], item_index=[2779], user_index=[], session_index=[2779], item_availability=[], price_cost_freq_ovt=[2779, 4, 3], session_income=[2779, 1], price_ivt=[2779, 4, 1], device=cuda:0)
==================== training the model ====================
Epoch 5000: Log-likelihood=-1892.477783203125
Epoch 10000: Log-likelihood=-1876.111328125
Epoch 15000: Log-likelihood=-1887.440673828125
Epoch 20000: Log-likelihood=-1874.94873046875
Epoch 25000: Log-likelihood=-1880.418701171875
Epoch 30000: Log-likelihood=-1875.380126953125
Epoch 35000: Log-likelihood=-1874.6539306640625
Epoch 40000: Log-likelihood=-1875.77490234375
Epoch 45000: Log-likelihood=-1884.27294921875
Epoch 50000: Log-likelihood=-1881.9267578125
==================== model results ====================
Training Epochs: 50000

Learning Rate: 0.01

Batch Size: 2779 out of 2779 observations in total

Final Log-likelihood: -1881.9267578125

Coefficients:

| Coefficient           |   Estimation |   Std. Err. |
|:----------------------|-------------:|------------:|
| price_cost_freq_ovt_0 |  -0.0335848  |  0.00724175 |
| price_cost_freq_ovt_1 |   0.0926003  |  0.00516289 |
| price_cost_freq_ovt_2 |  -0.0435459  |  0.00333631 |
| session_income_0      |  -0.0895265  |  0.0193202  |
| session_income_1      |  -0.0277154  |  0.00385749 |
| session_income_2      |  -0.0385979  |  0.00419459 |
| price_ivt_0           |   0.0594864  |  0.0102088  |
| price_ivt_1           |  -0.00710538 |  0.0046677  |
| price_ivt_2           |  -0.00623221 |  0.00192296 |
| price_ivt_3           |  -0.00182246 |  0.00121445 |
| intercept_0           |   0.700629   |  1.33349    |
| intercept_1           |   1.8497     |  0.720506   |
| intercept_2           |   3.27867    |  0.6386     |
Time taken: 74.3606629371643
</pre></div>
</div>
</section>
<section id="parameter-estimation">
<h2>Parameter Estimation<a class="headerlink" href="#parameter-estimation" title="Permalink to this headline">¶</a></h2>
<p>The following is the R-output from the <code class="docutils literal notranslate"><span class="pre">mlogit</span></code> implementation, the estimation, standard error, and log-likelihood from our <code class="docutils literal notranslate"><span class="pre">torch_choice</span></code> implementation is the same as the result from <code class="docutils literal notranslate"><span class="pre">mlogit</span></code> implementation.</p>
<section id="r-output">
<h3>R Output<a class="headerlink" href="#r-output" title="Permalink to this headline">¶</a></h3>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">install.packages</span><span class="p">(</span><span class="s">&quot;mlogit&quot;</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="s">&quot;mlogit&quot;</span><span class="p">)</span>
<span class="nf">data</span><span class="p">(</span><span class="s">&quot;ModeCanada&quot;</span><span class="p">,</span> <span class="n">package</span> <span class="o">=</span> <span class="s">&quot;mlogit&quot;</span><span class="p">)</span>
<span class="n">MC</span> <span class="o">&lt;-</span> <span class="nf">dfidx</span><span class="p">(</span><span class="n">ModeCanada</span><span class="p">,</span> <span class="n">subset</span> <span class="o">=</span> <span class="n">noalt</span> <span class="o">==</span> <span class="m">4</span><span class="p">)</span>
<span class="n">ml.MC1</span> <span class="o">&lt;-</span> <span class="nf">mlogit</span><span class="p">(</span><span class="n">choice</span> <span class="o">~</span> <span class="n">cost</span> <span class="o">+</span> <span class="n">freq</span> <span class="o">+</span> <span class="n">ovt</span> <span class="o">|</span> <span class="n">income</span> <span class="o">|</span> <span class="n">ivt</span><span class="p">,</span> <span class="n">MC</span><span class="p">,</span> <span class="n">reflevel</span><span class="o">=</span><span class="s">&#39;air&#39;</span><span class="p">)</span>

<span class="nf">summary</span><span class="p">(</span><span class="n">ml.MC1</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Call:
mlogit(formula = choice ~ cost + freq + ovt | income | ivt, data = MC, 
    reflevel = &quot;air&quot;, method = &quot;nr&quot;)

Frequencies of alternatives:choice
      air     train       bus       car 
0.3738755 0.1666067 0.0035984 0.4559194 

nr method
9 iterations, 0h:0m:0s 
g&#39;(-H)^-1g = 0.00014 
successive function values within tolerance limits 

Coefficients :
                    Estimate Std. Error  z-value  Pr(&gt;|z|)    
(Intercept):train  3.2741952  0.6244152   5.2436 1.575e-07 ***
(Intercept):bus    0.6983381  1.2802466   0.5455 0.5854292    
(Intercept):car    1.8441129  0.7085089   2.6028 0.0092464 ** 
cost              -0.0333389  0.0070955  -4.6986 2.620e-06 ***
freq               0.0925297  0.0050976  18.1517 &lt; 2.2e-16 ***
ovt               -0.0430036  0.0032247 -13.3356 &lt; 2.2e-16 ***
income:train      -0.0381466  0.0040831  -9.3426 &lt; 2.2e-16 ***
income:bus        -0.0890867  0.0183471  -4.8556 1.200e-06 ***
income:car        -0.0279930  0.0038726  -7.2286 4.881e-13 ***
ivt:air            0.0595097  0.0100727   5.9080 3.463e-09 ***
ivt:train         -0.0014504  0.0011875  -1.2214 0.2219430    
ivt:bus           -0.0067835  0.0044334  -1.5301 0.1259938    
ivt:car           -0.0064603  0.0018985  -3.4029 0.0006668 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Log-Likelihood: -1874.3
McFadden R^2:  0.35443 
Likelihood ratio test : chisq = 2058.1 (p.value = &lt; 2.22e-16)
</pre></div>
</div>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">torch-choice</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">Short Introduction to What this Package Does</a></li>
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="projects.html">Research Projects using this Package</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_management.html">Data Management Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_management.html#what-if-the-target-of-prediction-is-not-an-item-it-s-a-binary-variable-instead">What if the target of prediction is not an item? It’s a binary variable instead!</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Example of the Conditional Logit Model on ModeCanada Dataset</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#load-dataset">Load Dataset</a></li>
<li class="toctree-l2"><a class="reference internal" href="#create-the-model">Create the Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="#train-the-model">Train the Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="#parameter-estimation">Parameter Estimation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#r-output">R Output</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="nested_logit_model_house_cooling.html">Random Utility Model (RUM) Part II: Nested Logit Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="nested_logit_model_house_cooling.html#example-1">Example 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="nested_logit_model_house_cooling.html#example-2">Example 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="nested_logit_model_house_cooling.html#example-3">Example 3</a></li>
<li class="toctree-l1"><a class="reference internal" href="test.html">Compatibility Check List</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="data_management.html" title="previous chapter">Data Management Tutorial</a></li>
      <li>Next: <a href="nested_logit_model_house_cooling.html" title="next chapter">Random Utility Model (RUM) Part II: Nested Logit Model</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022, Tianyu Du, Ayush Kanodia.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.5.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/conditional_logit_model_mode_canada.md.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>