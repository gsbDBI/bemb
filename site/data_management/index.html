
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://example.com/data_management/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.2.13">
    
    
      
        <title>Tutorial for Data Management - Deep Choice</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.e411adfe.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.cc9b2e1e.min.css">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#tutorial-data-management" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Deep Choice" class="md-header__button md-logo" aria-label="Deep Choice" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Deep Choice
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Tutorial for  Data Management
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Deep Choice" class="md-nav__button md-logo" aria-label="Deep Choice" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Deep Choice
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../intro/" class="md-nav__link">
        About
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../install/" class="md-nav__link">
        Get Started
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Tutorial for  Data Management
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Tutorial for  Data Management
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#components-of-the-consumer-choice-modelling-problem" class="md-nav__link">
    Components of the Consumer Choice Modelling Problem
  </a>
  
    <nav class="md-nav" aria-label="Components of the Consumer Choice Modelling Problem">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#purchasing-record" class="md-nav__link">
    Purchasing Record
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#items-and-categories" class="md-nav__link">
    Items and Categories
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#users" class="md-nav__link">
    Users
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sessions" class="md-nav__link">
    Sessions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#item-availability" class="md-nav__link">
    Item Availability
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#observables" class="md-nav__link">
    Observables
  </a>
  
    <nav class="md-nav" aria-label="Observables">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#basic-usage" class="md-nav__link">
    Basic Usage
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#advanced-usage-additional-observables" class="md-nav__link">
    Advanced Usage: Additional Observables
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a-toy-example" class="md-nav__link">
    A Toy Example
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-choicedataset-object" class="md-nav__link">
    Creating  ChoiceDataset Object
  </a>
  
    <nav class="md-nav" aria-label="Creating  ChoiceDataset Object">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#step-1-generate-some-random-purchase-records-and-observables" class="md-nav__link">
    Step 1: Generate some random purchase records and observables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-2-initialize-the-choicedataset" class="md-nav__link">
    Step 2: Initialize the ChoiceDataset.
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#what-you-can-do-with-the-choicedataset" class="md-nav__link">
    What you can do with the ChoiceDataset?
  </a>
  
    <nav class="md-nav" aria-label="What you can do with the ChoiceDataset?">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#printdataset-and-dataset__str__" class="md-nav__link">
    print(dataset) and dataset.__str__
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#datasetnum_users-items-sessions" class="md-nav__link">
    dataset.num_{users, items, sessions}
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#datasetclone" class="md-nav__link">
    dataset.clone()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#datasettocuda-and-dataset_check_device_consistency" class="md-nav__link">
    dataset.to('cuda') and dataset._check_device_consistency().
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#subset-method" class="md-nav__link">
    Subset method
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-pytorch-dataloader-for-the-training-loop" class="md-nav__link">
    Using Pytorch dataloader for the training loop.
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#chaining-multiple-datasets-jointdataset-examples" class="md-nav__link">
    Chaining Multiple Datasets: JointDataset Examples
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../conditional_logit_model_mode_canada/" class="md-nav__link">
        Tutorial for Conditional Logit Model
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../nested_logit_model_house_cooling/" class="md-nav__link">
        Tutorial for Nested Logit Model
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../bemb/" class="md-nav__link">
        Tutorial for Bayesian Embedding (BEMB)
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../projects/" class="md-nav__link">
        Related Projects
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../test/" class="md-nav__link">
        Compability Tests
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../api_torch_choice/" class="md-nav__link">
        API Reference Torch-Choice
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../api_bemb/" class="md-nav__link">
        API Reference BEMB
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#components-of-the-consumer-choice-modelling-problem" class="md-nav__link">
    Components of the Consumer Choice Modelling Problem
  </a>
  
    <nav class="md-nav" aria-label="Components of the Consumer Choice Modelling Problem">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#purchasing-record" class="md-nav__link">
    Purchasing Record
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#items-and-categories" class="md-nav__link">
    Items and Categories
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#users" class="md-nav__link">
    Users
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sessions" class="md-nav__link">
    Sessions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#item-availability" class="md-nav__link">
    Item Availability
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#observables" class="md-nav__link">
    Observables
  </a>
  
    <nav class="md-nav" aria-label="Observables">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#basic-usage" class="md-nav__link">
    Basic Usage
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#advanced-usage-additional-observables" class="md-nav__link">
    Advanced Usage: Additional Observables
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a-toy-example" class="md-nav__link">
    A Toy Example
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-choicedataset-object" class="md-nav__link">
    Creating  ChoiceDataset Object
  </a>
  
    <nav class="md-nav" aria-label="Creating  ChoiceDataset Object">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#step-1-generate-some-random-purchase-records-and-observables" class="md-nav__link">
    Step 1: Generate some random purchase records and observables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-2-initialize-the-choicedataset" class="md-nav__link">
    Step 2: Initialize the ChoiceDataset.
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#what-you-can-do-with-the-choicedataset" class="md-nav__link">
    What you can do with the ChoiceDataset?
  </a>
  
    <nav class="md-nav" aria-label="What you can do with the ChoiceDataset?">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#printdataset-and-dataset__str__" class="md-nav__link">
    print(dataset) and dataset.__str__
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#datasetnum_users-items-sessions" class="md-nav__link">
    dataset.num_{users, items, sessions}
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#datasetclone" class="md-nav__link">
    dataset.clone()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#datasettocuda-and-dataset_check_device_consistency" class="md-nav__link">
    dataset.to('cuda') and dataset._check_device_consistency().
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#subset-method" class="md-nav__link">
    Subset method
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-pytorch-dataloader-for-the-training-loop" class="md-nav__link">
    Using Pytorch dataloader for the training loop.
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#chaining-multiple-datasets-jointdataset-examples" class="md-nav__link">
    Chaining Multiple Datasets: JointDataset Examples
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                


<h1 id="tutorial-data-management">Tutorial: Data Management</h1>
<p><strong>Author: Tianyu Du (tianyudu@stanford.edu)</strong></p>
<p>This notebook aims to help users understand the functionality of <code>ChoiceDataset</code> object.
The <code>ChoiceDataset</code> is an instance of the more general PyTorch dataset object holding information of consumer choices. The <code>ChoiceDataset</code> offers easy, clean and efficient data management.</p>
<p><strong>Note</strong>: since this package was initially proposed for modelling consumer choices, attribute names of <code>ChoiceDataset</code> are borrowed from the consumer choice literature.</p>
<p>The BEMB model was initially designed for predicting consumersâ€™ purchasing choices from the supermarket purchase dataset, we use the same setup in this tutorial as a running example. However, one can easily adopt the <code>ChoiceDataset</code> data structure to other use cases.</p>
<p><strong>Note</strong>: the Jupyter-notebook version of this tutorial can be found <a href="https://github.com/gsbDBI/torch-choice/blob/main/tutorials/data_management.ipynb">here</a>.</p>
<h2 id="components-of-the-consumer-choice-modelling-problem">Components of the Consumer Choice Modelling Problem</h2>
<p>We begin with essential component of the consumer choice modelling problem. Walking through these components should help you understand what kind of data our models are working on.</p>
<h3 id="purchasing-record">Purchasing Record</h3>
<p>Each row (record) of the dataset is called a <strong>purchasing record</strong>, which includes <em>who</em> bought <em>what</em> at <em>when</em> and <em>where</em>.
Let <span class="arithmatex">\(B\)</span> denote the number of <strong>purchasing records</strong> in the dataset (i.e., number of rows of the dataset). Each row <span class="arithmatex">\(b \in \{1,2,\dots, B\}\)</span> corresponds to a purchase record (i.e., <em>who</em> bought <em>what</em> at <em>where and when</em>).</p>
<h3 id="items-and-categories">Items and Categories</h3>
<p>To begin with, there are <span class="arithmatex">\(I\)</span> <strong>items</strong> indexed by <span class="arithmatex">\(i \in \{1,2,\dots,I\}\)</span> under our consideration.</p>
<p>Further, the researcher can optionally partition the set items into <span class="arithmatex">\(C\)</span> <strong>categories</strong> indexed by <span class="arithmatex">\(c \in \{1,2,\dots,C\}\)</span>. Let <span class="arithmatex">\(I_c\)</span> denote the collection of items in category <span class="arithmatex">\(c\)</span>, it is easy to verify that
$
\bigcup_{c \in {1, 2, \dots, C}} I_c = {1, 2, \dots I}
$
If the researcher does not wish to model different categories differently, the researcher can simply put all items in one single category: <span class="arithmatex">\(I_1 = \{1, 2, \dots I\}\)</span>, so that all items belong to the same category.</p>
<p><strong>Note</strong>: since we will be using PyTorch to train our model, we represent their identities with integer values instead of the raw human-readable names of items (e.g., Dell 24 inch LCD monitor).
Raw item names can be encoded easily with <a href="https://scikit-learn.org/stable/modules/generated/sklearn.preprocessing.OrdinalEncoder.html">sklearn.preprocessing.OrdinalEncoder</a>.</p>
<h3 id="users">Users</h3>
<p>Each purchaing reocrd is naturally associated with an <strong>user</strong> indexed by <span class="arithmatex">\(u \in \{1,2,\dots,U\}\)</span> (<em>who</em>) as well.</p>
<h3 id="sessions">Sessions</h3>
<p>Our data structure encompasses <em>where and when</em> using a notion called <strong>session</strong> indexed by <span class="arithmatex">\(s \in \{1,2,\dots, S\}\)</span>.
For example, when the data came from a single store over the period of a year. In this case, the notion of <em>where</em> does not matter that much, and session <span class="arithmatex">\(s\)</span> is simply the date of purchase.</p>
<p>Another example is that we have the purchase record from different stores, the session <span class="arithmatex">\(s\)</span> can be defined as a pair of <em>(date, store)</em> instead.</p>
<p>If the researcher does not wish to handle records from different sessions differently, the researcher can assign the same session ID to all rows of the dataset.</p>
<p>To summarize, each purchasing record <span class="arithmatex">\(b\)</span> in the dataset is characterized by a user-session-item tuple <span class="arithmatex">\((u, s, i)\)</span>.</p>
<p>When there are multiple items bought by the same user in the same session, there will be multiple rows in the dataset with the same <span class="arithmatex">\((u, s)\)</span> corresponding to the same receipt.</p>
<h3 id="item-availability">Item Availability</h3>
<p>It is not necessarily that all items are available in every session, items can get out-of-stock in particular sessions.</p>
<p>To handle these cases, the researcher can <em>optionally</em> provide a boolean tensor <span class="arithmatex">\(\in \{\texttt{True}, \texttt{False}\}^{S\times I}\)</span> to indicate which items are available for purchasing in each session.
While predicting the purchase probabilities, the model sets the probability for these unavailable items to zero and normalizes probabilities among available items.
If the item availability is not provided, the model assumes all items are available in all sessions.</p>
<h3 id="observables">Observables</h3>
<h4 id="basic-usage">Basic Usage</h4>
<p>Optionally, the researcher can incorporate observables of, for example, users and items. Currently, the package support the following types of observables, where <span class="arithmatex">\(K_{...}\)</span> denote the number of observables.</p>
<ol>
<li><code>user_obs</code> <span class="arithmatex">\(\in \mathbb{R}^{U\times K_{user}}\)</span></li>
<li><code>item_obs</code> <span class="arithmatex">\(\in \mathbb{R}^{I\times K_{item}}\)</span></li>
<li><code>session_obs</code> <span class="arithmatex">\(\in \mathbb{R}^{S \times K_{session}}\)</span></li>
<li><code>price_obs</code> <span class="arithmatex">\(\in \mathbb{R}^{S \times I \times K_{price}}\)</span>, price observables are values depending on <strong>both</strong> session and item.</li>
</ol>
<p>The researcher should supply them with as appropriate keyword arguments while constructing the <code>ChoiceDataset</code> object.</p>
<h4 id="advanced-usage-additional-observables">Advanced Usage: Additional Observables</h4>
<p>In some cases, the researcher may wish to handle different parts of <code>user_obs</code> (or other observable tensors) differently.
For example, the researcher wishes to model the utility for user <span class="arithmatex">\(u\)</span> to purchase item <span class="arithmatex">\(i\)</span> in session <span class="arithmatex">\(s\)</span> as the following:
$$
U_{usi} = \beta_{i} X^{(u)}<em>{user\ income} + \gamma X^{(u)}</em>{user\ market\ membership}
$$
The coefficient for user income is item-specific so that it captures the nature of the product (i.e., a luxury or an essential good). Additionally, the utility representation admits an user market membership becomes shoppers with active memberships tend to purchase more, and the coefficient of this term is constant across all items.
As we will cover later in the modelling section, we need to supply two user observable tensors in this case for the model to build coefficient with different levels of variations (i.e., item-specific coefficients versus constant coefficients). In this case, the researcher needs to supply two tensors <code>user_income</code> and <code>user_market_membership</code> as keyword arguments to the <code>ChoiceDataset</code> constructor.
The <code>ChoiceDataset</code> handles multiple user/item/session/price observables internally, for example, every keyword arguments passed into <code>ChoiceDataset</code> with name starting with <code>item_</code> (except for the reserved <code>item_availability</code>) will be treated as item observable tensors. All keywords with names starting <code>user_</code>, <code>session_</code> and <code>price_</code> (except for reserved names like <code>user_index</code> and <code>session_index</code> mentioned above) will be interpreted as user/session/price observable tensors.</p>
<h2 id="a-toy-example">A Toy Example</h2>
<p>Suppose we have a dataset of purchase history from two stores (Store A and B) on two dates (Sep 16 and 17), both stores sell {apple, banana, orange} (<code>num_items=3</code>) and there are three people came to those stores between Sep 16 and 17.</p>
<table>
<thead>
<tr>
<th>user_index</th>
<th>session_index</th>
<th>item_index</th>
</tr>
</thead>
<tbody>
<tr>
<td>Amy</td>
<td>Sep-17-2021-Store-A</td>
<td>banana</td>
</tr>
<tr>
<td>Ben</td>
<td>Sep-17-2021-Store-B</td>
<td>apple</td>
</tr>
<tr>
<td>Ben</td>
<td>Sep-16-2021-Store-A</td>
<td>orange</td>
</tr>
<tr>
<td>Charlie</td>
<td>Sep-16-2021-Store-B</td>
<td>apple</td>
</tr>
<tr>
<td>Charlie</td>
<td>Sep-16-2021-Store-B</td>
<td>orange</td>
</tr>
</tbody>
</table>
<p><strong>NOTE</strong>: For demonstration purpose, the example dataset has <code>user_index</code>, <code>session_index</code> and <code>item_index</code> as strings, they should be consecutive integers in actual production. One can easily convert them to integers using <code>sklearn.preprocessing.LabelEncoder</code>.</p>
<p>In the example above, 
- <code>user_index=[0,1,1,2,2]</code> (with encoding <code>0=Amy, 1=Ben, 2=Charlie</code>),
- <code>session_index=[0,1,2,3,3]</code> (with encoding <code>0=Sep-17-2021-Store-A, 1=Sep-17-2021-Store-B, 2=Sep-16-2021-Store-A, 3=Sep-16-2021-Store-B</code>),
- <code>item_index=[0,1,2,1,2]</code> (with encoding <code>0=banana, 1=apple, 2=orange</code>).</p>
<p>Suppose we believe people's purchasing decision depends on nutrition levels of these fruits, suppose apple has the highest nutrition level and banana has the lowest one, we can add</p>
<p><code>item_obs=[[1.5], [12.0], [3.3]]</code> <span class="arithmatex">\(\in \mathbb{R}^{3\times 1}\)</span>. The shape of this tensor is number-of-items by number-of-observable.</p>
<p><strong>NOTE</strong>: If someone went to one store and bought multiple items (e.g., Charlie bought both apple and orange at Store B on Sep-16), we include them as separate rows in the dataset and model them independently.</p>
<pre><code class="language-python"># import required dependencies.
import numpy as np
import torch
from torch_choice.data import ChoiceDataset, JointDataset
</code></pre>
<pre><code class="language-python"># let's get a helper
def print_dict_shape(d):
    for key, val in d.items():
        if torch.is_tensor(val):
            print(f'dict.{key}.shape={val.shape}')
</code></pre>
<h2 id="creating-choicedataset-object">Creating  <code>ChoiceDataset</code> Object</h2>
<pre><code class="language-python"># Feel free to modify it as you want.
num_users = 10
num_items = 4
num_sessions = 500

length_of_dataset = 10000
</code></pre>
<h3 id="step-1-generate-some-random-purchase-records-and-observables">Step 1: Generate some random purchase records and observables</h3>
<p>We will be creating a randomly generated dataset with 10000 purchase records from 10 users, 4 items and 500 sessions.</p>
<p>The first step is to randomly generate the purchase records using the following code. For simplicity, we assume all items are available in all sessions.</p>
<pre><code class="language-python"># create observables/features, the number of parameters are arbitrarily chosen.
# generate 128 features for each user, e.g., race, gender.
user_obs = torch.randn(num_users, 128)
# generate 64 features for each user, e.g., quality.
item_obs = torch.randn(num_items, 64)
# generate 10 features for each session, e.g., weekday indicator. 
session_obs = torch.randn(num_sessions, 10)
# generate 12 features for each session user pair, e.g., the budget of that user at the shopping day.
price_obs = torch.randn(num_sessions, num_items, 12)
</code></pre>
<p>We then generate random observable tensors for users, items, sessions and price observables, the size of observables of each type (i.e., the last dimension in the shape) is arbitrarily chosen.</p>
<pre><code class="language-python">item_index = torch.LongTensor(np.random.choice(num_items, size=length_of_dataset))
user_index = torch.LongTensor(np.random.choice(num_users, size=length_of_dataset))
session_index = torch.LongTensor(np.random.choice(num_sessions, size=length_of_dataset))

# assume all items are available in all sessions.
item_availability = torch.ones(num_sessions, num_items).bool()
</code></pre>
<h3 id="step-2-initialize-the-choicedataset">Step 2: Initialize the <code>ChoiceDataset</code>.</h3>
<p>You can construct a choice set using the following code, which manage all information for you.</p>
<pre><code class="language-python">dataset = ChoiceDataset(
    # pre-specified keywords of __init__
    item_index=item_index,  # required.
    # optional:
    user_index=user_index,
    session_index=session_index,
    item_availability=item_availability,
    # additional keywords of __init__
    user_obs=user_obs,
    item_obs=item_obs,
    session_obs=session_obs,
    price_obs=price_obs)
</code></pre>
<h2 id="what-you-can-do-with-the-choicedataset">What you can do with the <code>ChoiceDataset</code>?</h2>
<h3 id="printdataset-and-dataset__str__"><code>print(dataset)</code> and <code>dataset.__str__</code></h3>
<p>The command <code>print(dataset)</code> will provide a quick overview of shapes of tensors included in the object as well as where the dataset is located (i.e., host memory or GPU memory).</p>
<pre><code class="language-python">print(dataset)
</code></pre>
<pre><code>ChoiceDataset(label=[], item_index=[10000], user_index=[10000], session_index=[10000], item_availability=[500, 4], user_obs=[10, 128], item_obs=[4, 64], session_obs=[500, 10], price_obs=[500, 4, 12], device=cpu)
</code></pre>
<h3 id="datasetnum_users-items-sessions"><code>dataset.num_{users, items, sessions}</code></h3>
<p>You can use the <code>num_{users, items, sessions}</code> attribute to obtain the number of users, items, and sessions, they are determined automatically from the <code>{user, item, session}_obs</code> tensors provided while initializing the dataset object.</p>
<p><strong>Note</strong>: the print <code>=:</code> operator requires Python3.8 or higher, you can remove <code>=:</code> if you are using an earlier copy of Python.</p>
<pre><code class="language-python">print(f'{dataset.num_users=:}')
print(f'{dataset.num_items=:}')
print(f'{dataset.num_sessions=:}')
print(f'{len(dataset)=:}')
</code></pre>
<pre><code>dataset.num_users=10
dataset.num_items=4
dataset.num_sessions=500
len(dataset)=10000
</code></pre>
<h3 id="datasetclone"><code>dataset.clone()</code></h3>
<p>The <code>ChoiceDataset</code> offers a <code>clone</code> method allow you to make copy of the dataset, you can modify the cloned dataset arbitrarily without changing the original dataset.</p>
<pre><code class="language-python"># clone
print(dataset.item_index[:10])
dataset_cloned = dataset.clone()
dataset_cloned.item_index = 99 * torch.ones(num_sessions)
print(dataset_cloned.item_index[:10])
print(dataset.item_index[:10])  # does not change the original dataset.
</code></pre>
<pre><code>tensor([2, 2, 3, 1, 3, 2, 2, 1, 0, 1])
tensor([99., 99., 99., 99., 99., 99., 99., 99., 99., 99.])
tensor([2, 2, 3, 1, 3, 2, 2, 1, 0, 1])
</code></pre>
<h3 id="datasettocuda-and-dataset_check_device_consistency"><code>dataset.to('cuda')</code> and <code>dataset._check_device_consistency()</code>.</h3>
<p>One key advantage of the <code>torch_choice</code> and <code>bemb</code> is their compatibility with GPUs, you can easily move tensors in a <code>ChoiceDataset</code> object between host memory (i.e., cpu memory) and device memory (i.e., GPU memory) using <code>dataset.to()</code> method.
Please note that the following code runs only if your machine has a compatible GPU and GPU-compatible version of PyTorch installed.</p>
<p>Similarly, one can move data to host-memory using <code>dataset.to('cpu')</code>.
The dataset also provides a <code>dataset._check_device_consistency()</code> method to check if all tensors are on the same device.
If we only move the <code>label</code> to cpu without moving other tensors, this will result in an error message.</p>
<pre><code class="language-python"># move to device
print(f'{dataset.device=:}')
print(f'{dataset.device=:}')
print(f'{dataset.user_index.device=:}')
print(f'{dataset.session_index.device=:}')

dataset = dataset.to('cuda')

print(f'{dataset.device=:}')
print(f'{dataset.item_index.device=:}')
print(f'{dataset.user_index.device=:}')
print(f'{dataset.session_index.device=:}')
</code></pre>
<pre><code>dataset.device=cpu
dataset.device=cpu
dataset.user_index.device=cpu
dataset.session_index.device=cpu
dataset.device=cuda:0
dataset.item_index.device=cuda:0
dataset.user_index.device=cuda:0
dataset.session_index.device=cuda:0
</code></pre>
<pre><code class="language-python">dataset._check_device_consistency()
</code></pre>
<pre><code class="language-python"># # NOTE: this cell will result errors, this is intentional.
dataset.item_index = dataset.item_index.to('cpu')
dataset._check_device_consistency()
</code></pre>
<pre><code>---------------------------------------------------------------------------

Exception                                 Traceback (most recent call last)

&lt;ipython-input-56-40d626c6d436&gt; in &lt;module&gt;
      1 # # NOTE: this cell will result errors, this is intentional.
      2 dataset.item_index = dataset.item_index.to('cpu')
----&gt; 3 dataset._check_device_consistency()


~/Development/torch-choice/torch_choice/data/choice_dataset.py in _check_device_consistency(self)
    180                 devices.append(val.device)
    181         if len(set(devices)) &gt; 1:
--&gt; 182             raise Exception(f'Found tensors on different devices: {set(devices)}.',
    183                             'Use dataset.to() method to align devices.')
    184


Exception: ("Found tensors on different devices: {device(type='cuda', index=0), device(type='cpu')}.", 'Use dataset.to() method to align devices.')
</code></pre>
<pre><code class="language-python"># create dictionary inputs for model.forward()
# collapse to a dictionary object.
print_dict_shape(dataset.x_dict)
</code></pre>
<pre><code>dict.user_obs.shape=torch.Size([10000, 4, 128])
dict.item_obs.shape=torch.Size([10000, 4, 64])
dict.session_obs.shape=torch.Size([10000, 4, 10])
dict.price_obs.shape=torch.Size([10000, 4, 12])
</code></pre>
<h3 id="subset-method">Subset method</h3>
<p>One can use <code>dataset[indices]</code> with <code>indices</code> as an integer-valued tensor or array to get the corresponding rows of the dataset.
The example code block below queries the 6256-th, 4119-th, 453-th, 5520-th, and 1877-th row of the dataset object.
The <code>item_index</code>, <code>user_index</code>, <code>session_index</code> of the resulted subset will be different from the original dataset, but other tensors will be the same.</p>
<pre><code class="language-python"># __getitem__ to get batch.
# pick 5 random sessions as the mini-batch.
dataset = dataset.to('cpu')
indices = torch.Tensor(np.random.choice(len(dataset), size=5, replace=False)).long()
print(indices)
subset = dataset[indices]
print(dataset)
print(subset)
# print_dict_shape(subset.x_dict)

# assert torch.all(dataset.x_dict['price_obs'][indices, :, :] == subset.x_dict['price_obs'])
# assert torch.all(dataset.item_index[indices] == subset.item_index)
</code></pre>
<pre><code>tensor([1118,  976, 1956,  290, 8283])
ChoiceDataset(label=[], item_index=[10000], user_index=[10000], session_index=[10000], item_availability=[500, 4], user_obs=[10, 128], item_obs=[4, 64], session_obs=[500, 10], price_obs=[500, 4, 12], device=cpu)
ChoiceDataset(label=[], item_index=[5], user_index=[5], session_index=[5], item_availability=[500, 4], user_obs=[10, 128], item_obs=[4, 64], session_obs=[500, 10], price_obs=[500, 4, 12], device=cpu)
</code></pre>
<p>The subset method internally creates a copy of the datasets so that any modification applied on the subset will <strong>not</strong> be reflected on the original dataset.
The researcher can feel free to do in-place modification to the subset.</p>
<pre><code class="language-python">print(subset.item_index)
print(dataset.item_index[indices])

subset.item_index += 1  # modifying the batch does not change the original dataset.

print(subset.item_index)
print(dataset.item_index[indices])
</code></pre>
<pre><code>tensor([0, 1, 0, 0, 0])
tensor([0, 1, 0, 0, 0])
tensor([1, 2, 1, 1, 1])
tensor([0, 1, 0, 0, 0])
</code></pre>
<pre><code class="language-python">print(subset.item_obs[0, 0])
print(dataset.item_obs[0, 0])
subset.item_obs += 1
print(subset.item_obs[0, 0])
print(dataset.item_obs[0, 0])
</code></pre>
<pre><code>tensor(-1.5811)
tensor(-1.5811)
tensor(-0.5811)
tensor(-1.5811)
</code></pre>
<pre><code class="language-python">print(id(subset.item_index))
print(id(dataset.item_index[indices]))
</code></pre>
<pre><code>140339656298640
140339656150528
</code></pre>
<h2 id="using-pytorch-dataloader-for-the-training-loop">Using Pytorch dataloader for the training loop.</h2>
<p>The <code>ChoiceDataset</code> object natively support batch samplers from PyTorch. For demonstration purpose, we turned off the shuffling option.</p>
<pre><code class="language-python">from torch.utils.data.sampler import BatchSampler, SequentialSampler, RandomSampler
shuffle = False  # for demonstration purpose.
batch_size = 32

# Create sampler.
sampler = BatchSampler(
    RandomSampler(dataset) if shuffle else SequentialSampler(dataset),
    batch_size=batch_size,
    drop_last=False)

dataloader = torch.utils.data.DataLoader(dataset,
                                         sampler=sampler,
                                         num_workers=1,
                                         collate_fn=lambda x: x[0],
                                         pin_memory=(dataset.device == 'cpu'))
</code></pre>
<pre><code class="language-python">print(f'{item_obs.shape=:}')
item_obs_all = item_obs.view(1, num_items, -1).expand(len(dataset), -1, -1)
item_obs_all = item_obs_all.to(dataset.device)
item_index_all = item_index.to(dataset.device)
print(f'{item_obs_all.shape=:}')
</code></pre>
<pre><code>item_obs.shape=torch.Size([4, 64])
item_obs_all.shape=torch.Size([10000, 4, 64])
</code></pre>
<pre><code class="language-python">for i, batch in enumerate(dataloader):
    first, last = i * batch_size, min(len(dataset), (i + 1) * batch_size)
    idx = torch.arange(first, last)
    assert torch.all(item_obs_all[idx, :, :] == batch.x_dict['item_obs'])
    assert torch.all(item_index_all[idx] == batch.item_index)
</code></pre>
<pre><code class="language-python">batch.x_dict['item_obs'].shape
</code></pre>
<pre><code>torch.Size([16, 4, 64])
</code></pre>
<pre><code class="language-python">print_dict_shape(dataset.x_dict)
</code></pre>
<pre><code>dict.user_obs.shape=torch.Size([10000, 4, 128])
dict.item_obs.shape=torch.Size([10000, 4, 64])
dict.session_obs.shape=torch.Size([10000, 4, 10])
dict.price_obs.shape=torch.Size([10000, 4, 12])
</code></pre>
<pre><code class="language-python">dataset.__len__()
</code></pre>
<pre><code>10000
</code></pre>
<h2 id="chaining-multiple-datasets-jointdataset-examples">Chaining Multiple Datasets: <code>JointDataset</code> Examples</h2>
<pre><code class="language-python">dataset1 = dataset.clone()
dataset2 = dataset.clone()
joint_dataset = JointDataset(the_dataset=dataset1, another_dataset=dataset2)
</code></pre>
<pre><code class="language-python">joint_dataset
</code></pre>
<pre><code>JointDataset with 2 sub-datasets: (
    the_dataset: ChoiceDataset(label=[], item_index=[10000], user_index=[10000], session_index=[10000], item_availability=[500, 4], user_obs=[10, 128], item_obs=[4, 64], session_obs=[500, 10], price_obs=[500, 4, 12], device=cpu)
    another_dataset: ChoiceDataset(label=[], item_index=[10000], user_index=[10000], session_index=[10000], item_availability=[500, 4], user_obs=[10, 128], item_obs=[4, 64], session_obs=[500, 10], price_obs=[500, 4, 12], device=cpu)
)
</code></pre>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../install/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Get Started" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Get Started
            </div>
          </div>
        </a>
      
      
        
        <a href="../conditional_logit_model_mode_canada/" class="md-footer__link md-footer__link--next" aria-label="Next: Tutorial for Conditional Logit Model" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Tutorial for Conditional Logit Model
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.2a1c317c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.ed9748b7.min.js"></script>
      
        <script src="../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>